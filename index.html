<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hackathon Grader</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3f;
    --accent: #7c3aed;
    --accent2: #06d6a0;
    --accent3: #f72585;
    --text: #e8e8f0;
    --text-muted: #6b6b8a;
    --gold: #ffd60a;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      radial-gradient(ellipse 60% 40% at 20% 10%, rgba(124,58,237,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 40% 30% at 80% 80%, rgba(6,214,160,0.08) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; }

  /* NAV */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 2rem;
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,10,15,0.85);
  }

  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 1rem;
    letter-spacing: 0.1em;
    color: var(--accent2);
  }
  .logo span { color: var(--text-muted); }

  .nav-tabs {
    display: flex;
    gap: 0.25rem;
    background: var(--surface);
    padding: 0.25rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
  }

  .nav-tab {
    padding: 0.4rem 1rem;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    border-radius: 0.35rem;
    transition: all 0.2s;
  }
  .nav-tab.active {
    background: var(--accent);
    color: white;
  }

  /* PAGES */
  .page { display: none; padding: 2rem; max-width: 900px; margin: 0 auto; }
  .page.active { display: block; }

  /* SECTION TITLE */
  .section-title {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    letter-spacing: 0.15em;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 1.5rem;
  }

  /* CURRENT PROJECT BANNER */
  .current-banner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-left: 3px solid var(--accent2);
    border-radius: 0.75rem;
    padding: 1.25rem 1.5rem;
    margin-bottom: 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
  }

  .current-label {
    font-size: 0.7rem;
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 0.3rem;
  }

  .current-project-name {
    font-size: 1.5rem;
    font-weight: 800;
  }

  .live-dot {
    width: 10px;
    height: 10px;
    background: var(--accent2);
    border-radius: 50%;
    animation: pulse 1.5s infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.4; transform: scale(0.8); }
  }

  /* SCORE FORM */
  .score-grid {
    display: grid;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .criterion-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 1.25rem 1.5rem;
    transition: border-color 0.2s;
  }
  .criterion-card:focus-within { border-color: var(--accent); }

  .criterion-name {
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .score-display {
    font-family: 'Space Mono', monospace;
    font-size: 1.1rem;
    color: var(--accent2);
    min-width: 2.5rem;
    text-align: right;
  }

  .stars {
    display: flex;
    gap: 0.4rem;
    flex-wrap: wrap;
  }

  .star-btn {
    width: 38px;
    height: 38px;
    border-radius: 0.4rem;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text-muted);
    font-family: 'Space Mono', monospace;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.15s;
    font-weight: 700;
  }

  .star-btn:hover { border-color: var(--accent); color: var(--text); }
  .star-btn.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }

  .submit-btn {
    width: 100%;
    padding: 1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 0.75rem;
    font-family: 'Syne', sans-serif;
    font-size: 1rem;
    font-weight: 800;
    cursor: pointer;
    letter-spacing: 0.05em;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }
  .submit-btn:hover { background: #6d28d9; transform: translateY(-1px); }
  .submit-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  .success-msg {
    text-align: center;
    padding: 2rem;
    background: var(--surface);
    border: 1px solid var(--accent2);
    border-radius: 0.75rem;
    display: none;
  }
  .success-msg.show { display: block; }
  .success-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
  .success-msg h3 { font-size: 1.2rem; color: var(--accent2); }
  .success-msg p { color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem; }

  /* LEADERBOARD */
  .leaderboard { display: grid; gap: 0.75rem; }

  .lb-row {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 1rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s;
  }

  .lb-row.lb-new {
    animation: slideIn 0.35s ease forwards;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .lb-row:first-child {
    border-color: var(--gold);
    background: linear-gradient(135deg, rgba(255,214,10,0.07) 0%, var(--surface) 100%);
  }
  .lb-row:nth-child(2) { border-color: rgba(180,180,200,0.3); }
  .lb-row:nth-child(3) { border-color: rgba(180,100,50,0.3); }

  .lb-rank {
    font-family: 'Space Mono', monospace;
    font-size: 1.2rem;
    font-weight: 700;
    width: 2rem;
    text-align: center;
    color: var(--text-muted);
    flex-shrink: 0;
  }
  .lb-row:first-child .lb-rank { color: var(--gold); }

  .lb-name { font-weight: 700; font-size: 1rem; flex: 1; }

  .lb-votes {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .lb-score {
    font-family: 'Space Mono', monospace;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--accent2);
    min-width: 3.5rem;
    text-align: right;
  }

  .lb-bar-wrap {
    flex: 1;
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    max-width: 120px;
  }
  .lb-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 2px;
    transition: width 0.5s ease;
  }

  /* ADMIN */
  .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
  @media (max-width: 640px) { .admin-grid { grid-template-columns: 1fr; } }

  .admin-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 1.25rem;
  }

  .admin-card h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .project-list { display: grid; gap: 0.5rem; }

  .project-btn {
    width: 100%;
    text-align: left;
    padding: 0.75rem 1rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .project-btn:hover { border-color: var(--accent); }
  .project-btn.active-proj {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(6,214,160,0.05);
  }

  .vote-count {
    font-family: 'Space Mono', monospace;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .reset-btn {
    margin-top: 0.75rem;
    width: 100%;
    padding: 0.6rem;
    border: 1px solid var(--accent3);
    background: transparent;
    color: var(--accent3);
    border-radius: 0.5rem;
    font-family: 'Syne', sans-serif;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
  }
  .reset-btn:hover { background: rgba(247,37,133,0.1); }

  .stats-grid { display: grid; gap: 0.5rem; }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-val {
    font-family: 'Space Mono', monospace;
    color: var(--accent2);
    font-size: 0.9rem;
  }

  /* WAITING STATE */
  .waiting-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
  }
  .waiting-state .big { font-size: 3rem; margin-bottom: 1rem; }
  .waiting-state h3 { font-size: 1.1rem; color: var(--text); margin-bottom: 0.5rem; }

  /* EDIT MODE */
  .edit-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 0.75rem;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }
  .edit-section h3 {
    font-size: 0.75rem;
    font-family: 'Space Mono', monospace;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 1rem;
  }
  .tag-input-wrap { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; }
  .text-input {
    flex: 1;
    padding: 0.6rem 0.9rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 0.5rem;
    color: var(--text);
    font-family: 'Syne', sans-serif;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .text-input:focus { border-color: var(--accent); }
  .add-btn {
    padding: 0.6rem 1rem;
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 0.5rem;
    font-family: 'Syne', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    cursor: pointer;
  }
  .tags { display: flex; flex-wrap: wrap; gap: 0.4rem; }
  .tag {
    display: flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.75rem;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 2rem;
    font-size: 0.8rem;
    font-weight: 600;
  }
  .tag-remove {
    cursor: pointer;
    color: var(--text-muted);
    font-size: 1rem;
    line-height: 1;
    transition: color 0.2s;
  }
  .tag-remove:hover { color: var(--accent3); }

  .save-config-btn {
    padding: 0.75rem 2rem;
    background: var(--accent2);
    color: #0a0a0f;
    border: none;
    border-radius: 0.5rem;
    font-family: 'Syne', sans-serif;
    font-size: 0.9rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.2s;
  }
  .save-config-btn:hover { opacity: 0.85; }

  .badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 0.25rem;
    font-size: 0.65rem;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .badge-admin { background: rgba(247,37,133,0.15); color: var(--accent3); border: 1px solid rgba(247,37,133,0.3); }
</style>
</head>
<body>
<div class="app">
  <nav>
    <div class="logo">HACK<span>/</span>GRADE</div>
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchPage('judge')">Judge</button>
      <button class="nav-tab" onclick="switchPage('leaderboard')">Leaderboard</button>
      <button class="nav-tab" onclick="switchPage('admin')">Admin <span class="badge badge-admin">‚óè</span></button>
    </div>
  </nav>

  <!-- JUDGE PAGE -->
  <div id="page-judge" class="page active">
    <div class="section-title">// Judge Panel</div>

    <div id="judge-waiting" class="waiting-state" style="display:none">
      <div class="big">‚è≥</div>
      <h3>Waiting for next project...</h3>
      <p style="font-size:0.85rem;margin-top:0.25rem">The admin will switch to the next presentation shortly.</p>
    </div>

    <div id="judge-form-wrap">
      <div class="current-banner">
        <div>
          <div class="current-label">Now presenting</div>
          <div class="current-project-name" id="judge-project-name">‚Äî</div>
        </div>
        <div class="live-dot"></div>
      </div>

      <div id="score-form">
        <div class="score-grid" id="criteria-cards"></div>
        <button class="submit-btn" id="submit-btn" onclick="submitVote()">Submit Score</button>
      </div>

      <div class="success-msg" id="success-msg">
        <div class="success-icon">‚úÖ</div>
        <h3>Score submitted!</h3>
        <p>Waiting for the next project to be announced.</p>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD PAGE -->
  <div id="page-leaderboard" class="page">
    <div class="section-title">// Live Leaderboard</div>
    <div class="leaderboard" id="leaderboard-list"></div>
  </div>

  <!-- ADMIN PAGE -->
  <div id="page-admin" class="page">
    <div class="section-title">// Admin Panel</div>

    <!-- CONFIG SECTION -->
    <div class="edit-section" id="config-section">
      <h3>‚öô Setup ‚Äî Projects & Categories</h3>
      <div style="display:grid;gap:1rem;margin-bottom:1.25rem">
        <div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">Projects / Teams</div>
          <div class="tag-input-wrap">
            <input class="text-input" id="project-input" placeholder="e.g. Team Alpha" onkeydown="if(event.key==='Enter')addItem('project')">
            <button class="add-btn" onclick="addItem('project')">Add</button>
          </div>
          <div class="tags" id="project-tags"></div>
        </div>
        <div>
          <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.5rem">Scoring Categories</div>
          <div class="tag-input-wrap">
            <input class="text-input" id="criteria-input" placeholder="e.g. Innovation" onkeydown="if(event.key==='Enter')addItem('criteria')">
            <button class="add-btn" onclick="addItem('criteria')">Add</button>
          </div>
          <div class="tags" id="criteria-tags"></div>
        </div>
      </div>
      <button class="save-config-btn" onclick="saveConfig()">Save & Start Hackathon ‚Üí</button>
    </div>

    <!-- CONTROLS (shown after config saved) -->
    <div id="admin-controls" style="display:none">
      <div class="admin-grid">
        <div class="admin-card">
          <h3>üéØ Select Active Project</h3>
          <div class="project-list" id="admin-project-list"></div>
          <button class="reset-btn" onclick="resetAllVotes()">‚ö† Reset All Votes</button>
        </div>
        <div class="admin-card">
          <h3>üìä Live Stats</h3>
          <div class="stats-grid" id="admin-stats"></div>
        </div>
      </div>
      <div style="margin-top:1rem">
        <button class="reset-btn" style="width:auto;padding:0.5rem 1rem;border-color:var(--text-muted);color:var(--text-muted)" onclick="reconfigure()">‚Üê Reconfigure Projects</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// ‚îÄ‚îÄ‚îÄ FIREBASE INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const firebaseConfig = {
  apiKey: "AIzaSyDtQkBbbBJPK8-tGcQaYyTWEqTX0UAz7X4",
  authDomain: "taiko-hackathon.firebaseapp.com",
  projectId: "taiko-hackathon",
  storageBucket: "taiko-hackathon.firebasestorage.app",
  messagingSenderId: "328607716900",
  appId: "1:328607716900:web:8d647ae512165b37846ab1"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  projects: [],
  criteria: [],
  activeProject: null,
  votes: {},
  configured: false
};
let judgedProjects = new Set(); // local per-browser session
let currentScores = {};
let tempProjects = [];
let tempCriteria = [];
let lastActiveProject = null;

// ‚îÄ‚îÄ‚îÄ FIREBASE REFS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const configRef = doc(db, 'hackathon', 'config');
const votesCol = collection(db, 'votes');

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  showLoading(true);

  // Listen to config changes in real time
  onSnapshot(configRef, (snap) => {
    if (snap.exists()) {
      const data = snap.data();
      state.projects = data.projects || [];
      state.criteria = data.criteria || [];
      state.activeProject = data.activeProject || null;
      state.configured = data.configured || false;
      tempProjects = [...state.projects];
      tempCriteria = [...state.criteria];

      // If active project changed, reset local voted state for new project
      if (state.activeProject !== lastActiveProject) {
        lastActiveProject = state.activeProject;
        currentScores = {};
        renderJudgeForm();
      }

      renderConfigTags();
      updateJudgeView();
      renderAdminControls();

      if (state.configured) {
        document.getElementById('config-section').style.display = 'none';
        document.getElementById('admin-controls').style.display = 'block';
      } else {
        document.getElementById('config-section').style.display = 'block';
        document.getElementById('admin-controls').style.display = 'none';
      }
    } else {
      // No config yet
      renderConfigTags();
    }
    showLoading(false);
  });

  // Listen to votes in real time
  onSnapshot(votesCol, (snap) => {
    state.votes = {};
    snap.forEach(d => {
      const v = d.data();
      if (!state.votes[v.project]) state.votes[v.project] = [];
      state.votes[v.project].push(v.scores);
    });
    renderLeaderboard();
    renderAdminControls();
    renderAdminStats();
  });
}

function showLoading(show) {
  // Simple loading indicator in nav
  const logo = document.querySelector('.logo');
  logo.innerHTML = show ? 'HACK<span>/</span>GRADE <span style="color:var(--accent2);font-size:0.6rem">‚óè</span>' : 'HACK<span>/</span>GRADE';
}

// ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.switchPage = function(p) {
  document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
  document.getElementById('page-' + p).classList.add('active');
  event.target.classList.add('active');
  if (p === 'leaderboard') renderLeaderboard();
  if (p === 'admin') renderAdminControls();
}

// ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderConfigTags() {
  renderTags('project-tags', tempProjects, 'project');
  renderTags('criteria-tags', tempCriteria, 'criteria');
}

function renderTags(containerId, arr, type) {
  const el = document.getElementById(containerId);
  el.innerHTML = arr.map((item, i) => `
    <div class="tag">
      ${item}
      <span class="tag-remove" onclick="removeItem('${type}',${i})">√ó</span>
    </div>
  `).join('');
}

window.addItem = function(type) {
  const inp = document.getElementById(type === 'project' ? 'project-input' : 'criteria-input');
  const val = inp.value.trim();
  if (!val) return;
  if (type === 'project') tempProjects.push(val);
  else tempCriteria.push(val);
  inp.value = '';
  renderConfigTags();
}

window.removeItem = function(type, i) {
  if (type === 'project') tempProjects.splice(i, 1);
  else tempCriteria.splice(i, 1);
  renderConfigTags();
}

window.saveConfig = async function() {
  if (tempProjects.length === 0 || tempCriteria.length === 0) {
    alert('Please add at least one project and one category.');
    return;
  }
  await setDoc(configRef, {
    projects: tempProjects,
    criteria: tempCriteria,
    activeProject: tempProjects[0],
    configured: true
  });
}

window.reconfigure = async function() {
  if (!confirm('This will reconfigure the hackathon. Existing votes will remain but active project resets.')) return;
  await setDoc(configRef, { ...await (await getDoc(configRef)).data(), configured: false });
  document.getElementById('config-section').style.display = 'block';
  document.getElementById('admin-controls').style.display = 'none';
}

// ‚îÄ‚îÄ‚îÄ JUDGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderJudgeForm() {
  if (!state.configured || !state.activeProject) return;

  document.getElementById('judge-project-name').textContent = state.activeProject;

  const container = document.getElementById('criteria-cards');
  container.innerHTML = state.criteria.map(c => `
    <div class="criterion-card">
      <div class="criterion-name">
        <span>${c}</span>
        <span class="score-display" id="score-display-${slugify(c)}">‚Äî</span>
      </div>
      <div class="stars">
        ${[1,2,3,4,5,6,7,8,9,10].map(n => `
          <button class="star-btn" id="star-${slugify(c)}-${n}" onclick="setScore('${c}',${n})">${n}</button>
        `).join('')}
      </div>
    </div>
  `).join('');

  currentScores = {};
  updateSubmitBtn();
}

function updateJudgeView() {
  if (!state.configured || !state.activeProject) return;

  const alreadyVoted = judgedProjects.has(state.activeProject);
  document.getElementById('judge-project-name').textContent = state.activeProject;
  document.getElementById('score-form').style.display = alreadyVoted ? 'none' : 'block';
  document.getElementById('success-msg').classList.toggle('show', alreadyVoted);
  document.getElementById('judge-waiting').style.display = 'none';
  document.getElementById('judge-form-wrap').style.display = 'block';
}

window.setScore = function(criterion, value) {
  currentScores[criterion] = value;
  document.getElementById('score-display-' + slugify(criterion)).textContent = value + '/10';
  [1,2,3,4,5,6,7,8,9,10].forEach(n => {
    const btn = document.getElementById(`star-${slugify(criterion)}-${n}`);
    if (btn) btn.classList.toggle('selected', n <= value);
  });
  updateSubmitBtn();
}

function updateSubmitBtn() {
  const btn = document.getElementById('submit-btn');
  const allScored = state.criteria.every(c => currentScores[c] !== undefined);
  btn.disabled = !allScored;
  btn.textContent = allScored ? 'Submit Score ‚úì' : `Score all ${state.criteria.length} categories to submit`;
}

window.submitVote = async function() {
  if (!state.activeProject) return;
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = 'Submitting...';
  await addDoc(votesCol, {
    project: state.activeProject,
    scores: { ...currentScores },
    timestamp: Date.now()
  });
  judgedProjects.add(state.activeProject);
  document.getElementById('score-form').style.display = 'none';
  document.getElementById('success-msg').classList.add('show');
}

// ‚îÄ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLeaderboard() {
  const el = document.getElementById('leaderboard-list');
  if (!state.configured || state.projects.length === 0) {
    el.innerHTML = '<div class="waiting-state"><div class="big">üèÜ</div><h3>Hackathon not started yet</h3><p style="font-size:0.85rem;margin-top:0.25rem">Configure and start from the Admin panel.</p></div>';
    return;
  }

  const scores = state.projects.map(p => {
    const pvotes = state.votes[p] || [];
    const avg = pvotes.length === 0 ? null : (() => {
      const total = pvotes.reduce((sum, v) => sum + Object.values(v).reduce((a,b) => a+b, 0) / Object.values(v).length, 0);
      return (total / pvotes.length).toFixed(2);
    })();
    return { name: p, avg, votes: pvotes.length };
  }).sort((a, b) => {
    if (a.avg === null && b.avg === null) return 0;
    if (a.avg === null) return 1;
    if (b.avg === null) return -1;
    return b.avg - a.avg;
  });

  const existingRows = {};
  el.querySelectorAll('.lb-row[data-project]').forEach(row => {
    existingRows[row.dataset.project] = row;
  });

  scores.forEach((s, i) => {
    const rankIcon = s.avg !== null ? (i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1) : '‚Äî';
    const barWidth = s.avg !== null ? (s.avg / 10 * 100) : 0;
    const scoreText = s.avg !== null ? s.avg : '‚Äî';
    const votesText = `${s.votes} vote${s.votes !== 1 ? 's' : ''}`;
    const borderColor = i === 0 ? 'var(--gold)' : i === 1 ? 'rgba(180,180,200,0.3)' : i === 2 ? 'rgba(180,100,50,0.3)' : '';
    const bg = i === 0 ? 'linear-gradient(135deg, rgba(255,214,10,0.07) 0%, var(--surface) 100%)' : '';

    if (existingRows[s.name]) {
      const row = existingRows[s.name];
      row.querySelector('.lb-rank').textContent = rankIcon;
      row.querySelector('.lb-bar').style.width = barWidth + '%';
      row.querySelector('.lb-votes').textContent = votesText;
      row.querySelector('.lb-score').textContent = scoreText;
      row.style.borderColor = borderColor;
      row.style.background = bg;
      el.appendChild(row);
    } else {
      const row = document.createElement('div');
      row.className = 'lb-row lb-new';
      row.dataset.project = s.name;
      row.style.borderColor = borderColor;
      row.style.background = bg;
      row.innerHTML = `
        <div class="lb-rank">${rankIcon}</div>
        <div class="lb-name">${s.name}</div>
        <div class="lb-bar-wrap"><div class="lb-bar" style="width:${barWidth}%"></div></div>
        <div class="lb-votes">${votesText}</div>
        <div class="lb-score">${scoreText}</div>
      `;
      el.appendChild(row);
      row.addEventListener('animationend', () => row.classList.remove('lb-new'), { once: true });
    }
  });
}

// ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAdminControls() {
  if (!state.configured) return;
  const list = document.getElementById('admin-project-list');
  list.innerHTML = state.projects.map(p => `
    <button class="project-btn ${state.activeProject === p ? 'active-proj' : ''}" onclick="setActiveProject('${p}')">
      ${p}
      <span class="vote-count">${(state.votes[p] || []).length} votes</span>
    </button>
  `).join('');
  renderAdminStats();
}

function renderAdminStats() {
  if (!state.configured) return;
  const el = document.getElementById('admin-stats');
  const totalVotes = Object.values(state.votes).reduce((s, v) => s + v.length, 0);
  const gradedProjects = Object.values(state.votes).filter(v => v.length > 0).length;
  el.innerHTML = `
    <div class="stat-row"><span>Active Project</span><span class="stat-val">${state.activeProject || '‚Äî'}</span></div>
    <div class="stat-row"><span>Total Votes Cast</span><span class="stat-val">${totalVotes}</span></div>
    <div class="stat-row"><span>Projects Graded</span><span class="stat-val">${gradedProjects} / ${state.projects.length}</span></div>
    <div class="stat-row"><span>Scoring Categories</span><span class="stat-val">${state.criteria.length}</span></div>
  `;
}

window.setActiveProject = async function(name) {
  const data = (await getDoc(configRef)).data();
  await setDoc(configRef, { ...data, activeProject: name });
}

window.resetAllVotes = async function() {
  if (!confirm('Reset ALL votes? This cannot be undone.')) return;
  const snap = await getDocs(votesCol);
  await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
  judgedProjects = new Set();
  currentScores = {};
  renderJudgeForm();
}

// ‚îÄ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function slugify(s) { return s.toLowerCase().replace(/[^a-z0-9]/g, '-'); }

init();
</script>
</body>
</html>
